# UAP_SIM
模拟中国结算账户系统数据接口逻辑，主要用于开发测试等目的。
以下为开发过程记录。项目主旨目标详见2019年6月26日记录。

20201123
回归一年半前的初心，把项目放到github上，有兴趣的可以参与维护

-----------------------------------------------------------------------

2020-09-16
王秀萍、李峰元贡献 UAPSRV13 适当性信息管理维护，及相应的建表脚本
TODO:将适当性信息库加入数据库模型，生成统一建表脚本

-----------------------------------------------------------------------

2019-08-28
完成 UAPSRV11 证券账户使用信息维护

-----------------------------------------------------------------------

2019-08-25
改进EXE程序：
1、对于尚未支持的业务跳过，这样旧版的模拟器也能进行部分业务的补充支持
2、每次轮询仅从上次处理完成的记录下一条开始轮询，当REQ文件上万啥的时候不需要遍历整个文件。

-----------------------------------------------------------------------


2019-08-21
完成 UAPSRV06 账户注册资料查询、 UAPSRV09首次交易日查询。 

-----------------------------------------------------------------------

2019-08-19
灾难性事件，取来账户系统的dump想把本地的系统更新到最新，结果成功把旧的数据库拱了，数据恢复失败。
因为dump是oracle10 做的，而我本地是oracle10。牙一咬脚一跺，本地也装oracle11。
然后就发现windows上装oralce11也要看运气。64位oracle上去就会发现32位的PL/SQL Developer 不正常了……
趟平了数据库的坑又掉进jboss的坑……然后，是账户系统配置的坑……
总之，每一步都是坑，每一步都是血泪控诉。花了两个星期，到今天才算把所有坑填平。

完成UAPSRV03 一码通注册资料修改基本逻辑。
为了验证UAPSRV03 发现界面会先做UAPSRV06。

(╯‵□′)╯︵┻━┻

-----------------------------------------------------------------------

2019-08-06
完成UAPSRV02 证券账户开户的基本逻辑，但是证券账户开户的前置判断逻辑还需要继续写。
至少的，今天一步式一码通开户和多个市场证券账户开户成功！！！

-----------------------------------------------------------------------

2019-08-05
解决开发环境的问题，有一个组件莫名其妙丢失了，即使VS重装也无法解决。同一个报错，网络上五花八门的说法，逐个测试，最后搞定解决问题的链接记录一下
https://jingyan.baidu.com/article/15622f24d95bb9fdfdbea57f.html 


-----------------------------------------------------------------------

2019-08-03
完成UAPSRV08，发现空记录的返回逻辑并不是做UAPSRV07的那样直接返回空表。实际上应该返回一条与业务流水号匹配的记录回来，但是UAPSRV07目前没有报错，暂时不动。后续修正
UAPSRV08测试通过后 UAPSRV01一次性成功。
接下来处理UAPSRV02 证券账户开立。在此之前需要完善参数配置，需要设置单一市场下证券账户开户数。
灾难性的，不知咋地vs2017崩溃了，工程开不起来了，好在已经编译出来的exe能用，不影响写存储过程

-----------------------------------------------------------------------

2019-07-29
停更两个星期，今天继续完成UAPSRV01 一码通开户逻辑，但是还没有测试，因为一码通开户前先要做一码通查询，下一个目标是UAPSRV08 一码通账户查询。
发现当存储过程不存在的时候，模拟程序客户端会不停弹出对话框。这个问题要解决。

-----------------------------------------------------------------------

2019-07-14
整理数据库脚本。配置管理做起来，备份做起来。
规划后续的业务实现优先级，数据库表结构要整体规划之前只准备了最基本的账户业务，后续适当性管理、TA基
金账户关联等业务要进行表的扩展。
表结构的一些调整，非主键的必填字段做限制免得测试的时候瞎填。
生成最小业务验证发布包。

-----------------------------------------------------------------------

2019-07-11
用二进制比较老模拟器生成的回报和我的回报文件，发现老模拟器生成的回报文件顶着foxpro2.x的版本标志，但文件内容是foxpro3.0格式。超代居然处理OK，厉害！找到了Prop通用接口技术手册，明确了回报应该是2.x版本格式。我！没！错！
接下来的操作是在REP文件里插一条回报索引，再在REQ文件里更新一个处理标志。也就是说要做DBF的insert和update逻辑，继续掰着手指头数字节…… 
24点前业务闭环完成！！ 证券账户查询业务测试，几个场景反馈都正确。睡觉！

-----------------------------------------------------------------------

2019-07-10
1、仿得尽量真点，初始化了截至2019年5月的开户代理机构网点。这样UAPSRV07的三个机构名称字段的返回就模拟的和生产环境一致了。
2、为了防止在未来的测试中无法辨别是否是仿真模拟返回，今后在一些不影响业务逻辑的数据上加入一些彩蛋提示，让返回的结果能一眼看出这是仿真结果。
有点矛盾？
继续完成DBF文件Create模块，思路清晰，键盘敲得啪啪的，一气呵成，编译一次通过无警告。运行起来生成的DBF居然和旧版模拟器的结果文件大小不一致。心态炸了，睡觉！

-----------------------------------------------------------------------

2019-07-09
完成根据结构数据生成DBF头信息模块，不过还没验证正确性。毕竟又是在数字节。
结构体转换为字节数组的过程中出现麻烦，暂未解决。

-----------------------------------------------------------------------

2019-07-07
创建了一码通表和证券账户表的测试样例数据。
实现首个业务逻辑存储过程——UAPSRV07 证券账户查询。支持三种查询方式：用一码通或三要素查询回来所有证券账户，直接用账户类型+账号仅返回单条账户数据。比起旧模拟器的固定返回两条记录帅多了。 

-----------------------------------------------------------------------

2019-07-06
数据库方面完成中国结算接口字典初始化
完成所有接口字段数据的提取和初始化，幸好有一个word版本的1.44非正式接口，要不用PDF弄会吐血。

-----------------------------------------------------------------------

2019-07-03
完成DBF头结构解析代码，数字节数的眼花。实现了DBF数据读。
完成oracle访问类，编写一个简单的存储过程实例做测试。

-----------------------------------------------------------------------


2019-07-01
业务闭环：账户系统发起指令 -> 中登超代接受XML指令 -> REQ.dbf中写入一条索引记录 -> 按照UAP接口写接口DBF-> 模拟器读取REQ.dbf，根据索引数据找到接口DBF -> 根据接口DBF组织数据调用相应服务编号命名的存储过程 -> 存储过程按照业务逻辑完成相应记录的增删改查，按照回报接口字段组织数据返回数据集 -> 模拟程序查询业务回报接口结构，根据返回的数据集生成回报数据DBF -> REP.DBF中写入一条回报索引记录 -> 修改REQ.DBF中索引记录的状态。

-----------------------------------------------------------------------

2019-06-30
辅助工具建设
1、创建数据库表结构模板。自动化生成数据库建表脚本
2、组织数据库脚本，执行一个BAT生成所需的一切。
3、VBA工具，用于提取UAP文档中的数据库表结构、接口字段信息。

-----------------------------------------------------------------------


2019-06-29
技术选型
1、虽然用VB可能会更快，但是觉得还是放弃VB吧，都啥年代了。最终确定桌面程序采用C#实现，VS2017。
2、C#采用.net FrameWork 4.0 win10自带，win7需要安装。
3、不使用微软的oracleclient类库，使用oracle的ODP.NET 免oracle客户端安装。
3、数据库端使用oracle实现。库表实现一码通、证券账户以及一系列其他业务控制的勾稽关系。
4、所有UAP逻辑用存储过程实现。存储过程命名以及参数与UAP接口相同，按照UAP接口的返回字段返回数据集游标。
5、DBF操作放弃模板库方式。回报DBF文件结构由客户端根据DBF文件规范自行创建文件。
6、接口文件结构维护在数据库中，客户端提取后，根据结构生成DBF头结构。再拼接数据。

-----------------------------------------------------------------------

2019-06-26
原有模拟器的问题
1、采用标准数据引擎处理DBF，当DBF数据量大的时候由于没有索引，数据索引会越来越慢
2、单次轮询只处理一条请求，然后再延时（默认3秒）。要了命了，开发测试没问题，全网测试根本扛不住。
3、所有请求根据INI文件设定固定返回，没有业务逻辑。
4、基于 .Net FrameWork 2.0 不论哪个版本的windows都要额外安装框架
5、需要安装foxpro数据驱动，这玩意只有32位版本，于是连累程序必须全部使用32位组件。

新模拟器需要达到的目标
1、DBF用文件流的方式处理，目标不管文件多大都够快
2、采用C/S架构，业务逻辑在数据库中用存储过程实现。所有存储过程明码，便于维护。
3、客户端不需要升级，后续业务规则的变化、以及新增接口，只需要调整数据库端，客户端自洽。
4、绿色，至少针对win10绿色，拷贝过去就能用。
5、不需要安装数据库客户端数据库驱动。

其他：
该项目不利用工作时间和工作环境、工作设备。此项目为个人兴趣
项目最终扔github开源，有需要自行下载，作者凭心情做后续更新，欢迎共同参与维护。
作者不对正确性、及时性负责。

-----------------------------------------------------------------------

2019-06-25
两融整合工作完毕。期间发现在测试过程中由于中登模拟的问题，导致性能、逻辑等一系列问题。
考虑到普通交易的整合需要更多的测试项目，决定还是要把这个项目继续下去。

-----------------------------------------------------------------------

2019-02-21
心血来潮扶flag，弄来了prop超代全套测试工具。摆弄了一个多小时，又把flag放平。

-----------------------------------------------------------------------

2019-02-01	
换了一台电脑，进行硬盘数据进行备份的时候看到了模拟器源代码目录。心存一念，挪到了新机器上。

-----------------------------------------------------------------------

2018-11-??
弄来了新意UAP模拟回报3.0版本的代码。RTFSC!!!
弄的过程中得到了申万测试部、开发部、新意的精神鼓励。
read了一整天，然后flag倒了。

-----------------------------------------------------------------------

2018-10-??
忘了哪一天了，验收中国结算新的账户业务，有点受不了原来的模拟器，无法模拟出业务场景，于是立下flag要重做一个UAP的模拟器。
按照以往的经验，flag经常倒掉……****